
function updateUI() {
    // Afficher les trades dans le journal
    const body = document.getElementById('tradesBody');
    body.innerHTML = '';
    
    trades.forEach(trade => {
        const row = document.createElement('tr');
        const isWin = trade.resultUSD > 0;
        row.innerHTML = `
            <td>${trade.date}</td>
            <td>${trade.asset}</td>
            <td><span class="badge ${trade.direction === 'Long' ? 'badge-long' : 'badge-short'}">${trade.direction}</span></td>
            <td>${parseFloat(trade.entry).toFixed(2)}</td>
            <td><span class="badge ${isWin ? 'badge-long' : 'badge-short'}">${trade.resultUSD > 0 ? '+' : ''}$${parseFloat(trade.resultUSD).toFixed(2)}</span></td>
            <td><button class="btn-red" style="padding: 4px 8px; font-size: 12px;" onclick="deleteTrade(${trade.id})">×</button></td>
        `;
        body.appendChild(row);
    });

    // Calculer les statistiques
    const wins = trades.filter(t => t.resultUSD > 0);
    const losses = trades.filter(t => t.resultUSD < 0);
    const totalGain = wins.reduce((sum, t) => sum + parseFloat(t.resultUSD), 0);
    const totalLoss = Math.abs(losses.reduce((sum, t) => sum + parseFloat(t.resultUSD), 0));
    const avgGain = wins.length > 0 ? totalGain / wins.length : 0;
    const avgLoss = losses.length > 0 ? totalLoss / losses.length : 0;
    const winrate = trades.length > 0 ? (wins.length / trades.length * 100).toFixed(2) : 0;
    const totalPnL = trades.reduce((sum, t) => sum + parseFloat(t.resultUSD), 0);
    const profitFactor = totalLoss > 0 ? (totalGain / totalLoss).toFixed(2) : (totalGain > 0 ? 999 : 0);

    // Calculer Sharpe Ratio (simplifié)
    const returns = trades.map(t => parseFloat(t.resultUSD));
    const meanReturn = returns.length > 0 ? returns.reduce((a, b) => a + b, 0) / returns.length : 0;
    const variance = returns.length > 0 ? returns.reduce((sum, r) => sum + Math.pow(r - meanReturn, 2), 0) / returns.length : 0;
    const stdDev = Math.sqrt(variance);
    const sharpe = stdDev > 0 ? (meanReturn / stdDev * Math.sqrt(252)).toFixed(2) : 0;

    // Expectancy (espérance mathématique)
    const expectancy = trades.length > 0 ? (totalPnL / trades.length).toFixed(2) : 0;

    // Max Drawdown
    let maxDD = 0;
    let runningMax = 0;
    let cumPnL = 0;
    trades.forEach(trade => {
        cumPnL += parseFloat(trade.resultUSD);
        if (cumPnL > runningMax) runningMax = cumPnL;
        const dd = runningMax - cumPnL;
        if (dd > maxDD) maxDD = dd;
    });

    // Mise à jour du capital
    const account = accounts.find(a => a.id === currentAccount);
    const currentCapital = (account ? account.capital : 0) + totalPnL;

    // Mettre à jour les KPIs
    document.getElementById('perf').textContent = ((totalPnL / (account?.capital || 10000) * 100).toFixed(2)) + '%';
    document.getElementById('capital').textContent = '$' + currentCapital.toFixed(2);
    document.getElementById('winrate').textContent = winrate + '%';
    document.getElementById('pf').textContent = profitFactor;
    document.getElementById('maxdd').textContent = maxDD.toFixed(2) + '$';
    document.getElementById('avggain').textContent = '$' + avgGain.toFixed(2);
    document.getElementById('sharpe').textContent = sharpe;
    document.getElementById('expectancy').textContent = '$' + expectancy;

    // Statistiques détaillées
    document.getElementById('detail-avggain').textContent = '$' + avgGain.toFixed(2);
    document.getElementById('detail-avgloss').textContent = '$' + avgLoss.toFixed(2);
    document.getElementById('detail-ratio').textContent = (avgLoss > 0 ? (avgGain / avgLoss).toFixed(2) : 0);
    document.getElementById('detail-total').textContent = trades.length;
    document.getElementById('detail-wins').textContent = wins.length;
    document.getElementById('detail-losses').textContent = losses.length;
    document.getElementById('detail-leverage').textContent = '1x';
    document.getElementById('detail-rr').textContent = ((parseFloat(document.getElementById('tp')?.value || 0) - parseFloat(document.getElementById('entry')?.value || 0)) / (parseFloat(document.getElementById('entry')?.value || 0) - parseFloat(document.getElementById('sl')?.value || 0))).toFixed(2) || 0;
    document.getElementById('detail-vol').textContent = '$' + stdDev.toFixed(2);

    // Trades détaillés
    const tradesDetailsDiv = document.getElementById('tradesDetails');
    tradesDetailsDiv.innerHTML = '';
    trades.forEach(trade => {
        const card = document.createElement('div');
        card.className = 'trade-card';
        const isWin = parseFloat(trade.resultUSD) > 0;
        card.innerHTML = `
            <div class="trade-header">
                <div>
                    <strong>${trade.asset}</strong> - ${trade.date}
                </div>
                <span class="badge ${trade.direction === 'Long' ? 'badge-long' : 'badge-short'}">${trade.direction}</span>
            </div>
            <div class="trade-meta">
                <div><span style="color: #94a3b8;">Entry:</span> ${parseFloat(trade.entry).toFixed(2)}</div>
                <div><span style="color: #94a3b8;">SL:</span> ${parseFloat(trade.sl).toFixed(2)}</div>
                <div><span style="color: #94a3b8;">TP:</span> ${parseFloat(trade.tp).toFixed(2)}</div>
                <div><span style="color: #94a3b8;">R:R:</span> ${((parseFloat(trade.tp) - parseFloat(trade.entry)) / (parseFloat(trade.entry) - parseFloat(trade.sl))).toFixed(2)}</div>
            </div>
            <div class="trade-result ${isWin ? 'win' : 'loss'}">
                ${isWin ? '+' : ''}$${parseFloat(trade.resultUSD).toFixed(2)}
            </div>
            ${trade.comment ? `<div style="color: #cbd5e1; margin-top: 8px; font-size: 13px;">${trade.comment}</div>` : ''}
            ${trade.screenshot ? `<img src="${trade.screenshot}" class="trade-image" onclick="openModal('${trade.screenshot}')">` : ''}
        `;
        tradesDetailsDiv.appendChild(card);
    });

    // Charger et mettre à jour les graphiques
    updateCharts();
}

function updateCharts() {
    // Equity Curve
    let cumPnL = 0;
    const equityData = trades.map(trade => {
        cumPnL += parseFloat(trade.resultUSD);
        return cumPnL;
    });
    
    const account = accounts.find(a => a.id === currentAccount);
    const initialCapital = account?.capital || 10000;
    const equityValues = equityData.map(pnl => initialCapital + pnl);
    
    const equityCtx = document.getElementById('equityChart')?.getContext('2d');
    if (equityCtx) {
        if (equityChart) equityChart.destroy();
        equityChart = new Chart(equityCtx, {
            type: 'line',
            data: {
                labels: trades.map((_, i) => i + 1),
                datasets: [{
                    label: 'Equity',
                    data: equityValues,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: false, grid: { color: '#475569' }, ticks: { color: '#94a3b8' } },
                    x: { grid: { color: '#475569' }, ticks: { color: '#94a3b8' } }
                }
            }
        });
    }

    // P&L par Trade
    const balanceCtx = document.getElementById('balanceChart')?.getContext('2d');
    if (balanceCtx) {
        if (balanceChart) balanceChart.destroy();
        const colors = trades.map(t => parseFloat(t.resultUSD) > 0 ? '#4ade80' : '#f87171');
        balanceChart = new Chart(balanceCtx, {
            type: 'bar',
            data: {
                labels: trades.map((_, i) => i + 1),
                datasets: [{
                    label: 'P&L',
                    data: trades.map(t => parseFloat(t.resultUSD)),
                    backgroundColor: colors,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { grid: { color: '#475569' }, ticks: { color: '#94a3b8' } },
                    x: { grid: { color: '#475569' }, ticks: { color: '#94a3b8' } }
                }
            }
        });
    }
}


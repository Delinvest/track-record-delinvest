
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L'Art du Trading</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%); color: #fff; min-height: 100vh; padding: 24px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .auth-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .auth-box { background: #334155; border: 1px solid #475569; border-radius: 8px; padding: 40px; text-align: center; max-width: 400px; }
        .auth-box h1 { font-size: 28px; margin-bottom: 8px; background: linear-gradient(90deg, #60a5fa, #22d3ee); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .auth-box p { color: #94a3b8; margin-bottom: 24px; }
        .auth-box input { width: 100%; padding: 12px; margin-bottom: 16px; background: #475569; border: 1px solid #334155; color: white; border-radius: 6px; font-size: 14px; }
        .auth-box button { width: 100%; padding: 12px; background: #16a34a; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-bottom: 12px; }
        .auth-box button:hover { background: #15803d; }
        .auth-toggle { color: #94a3b8; font-size: 14px; cursor: pointer; }
        .auth-toggle a { color: #60a5fa; cursor: pointer; }
        h1 { font-size: 36px; font-weight: bold; margin-bottom: 4px; background: linear-gradient(90deg, #60a5fa, #22d3ee); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .subtitle { color: #94a3b8; margin-bottom: 24px; font-size: 14px; }
        .header { border-bottom: 1px solid #334155; padding-bottom: 24px; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; }
        button { padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s; font-size: 14px; }
        .btn-blue { background: #2563eb; color: white; }
        .btn-blue:hover { background: #1d4ed8; }
        .btn-green { background: #16a34a; color: white; }
        .btn-green:hover { background: #15803d; }
        .btn-purple { background: #9333ea; color: white; }
        .btn-purple:hover { background: #7e22ce; }
        .btn-red { background: #dc2626; color: white; }
        .btn-red:hover { background: #b91c1c; }
        .account-selector { display: flex; gap: 8px; align-items: center; margin-bottom: 16px; flex-wrap: wrap; }
        .account-button { padding: 8px 12px; border: 2px solid #475569; border-radius: 6px; background: transparent; color: #cbd5e1; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .account-button.active { border-color: #06b6d4; background: rgba(6, 182, 212, 0.2); color: #06b6d4; }
        .tabs { display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; }
        .tab { padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; background: #475569; color: #cbd5e1; transition: all 0.3s; border: none; font-size: 14px; }
        .tab.active { background: linear-gradient(90deg, #3b82f6, #06b6d4); color: #0f172a; }
        .content { display: none; }
        .content.active { display: block; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .kpi-card { background: #334155; border: 1px solid #475569; border-radius: 8px; padding: 20px; }
        .kpi-label { color: #94a3b8; font-size: 12px; margin-bottom: 8px; text-transform: uppercase; }
        .kpi-value { font-size: 28px; font-weight: bold; margin-bottom: 4px; }
        .green { color: #4ade80; }
        .blue { color: #60a5fa; }
        .cyan { color: #06b6d4; }
        .red { color: #f87171; }
        .form-input { background: #475569; border: 1px solid #334155; color: white; padding: 8px 12px; border-radius: 6px; font-size: 14px; margin-bottom: 12px; width: 100%; }
        .form-input:focus { outline: none; border-color: #3b82f6; }
        .hidden { display: none !important; }
        table { width: 100%; border-collapse: collapse; background: #334155; border-radius: 8px; overflow: hidden; margin-bottom: 24px; }
        thead { background: #1e293b; }
        th, td { padding: 12px 16px; text-align: left; font-size: 13px; }
        td { border-bottom: 1px solid #475569; }
        tbody tr:hover { background: #3f4654; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .badge-long { background: #166534; color: #86efac; }
        .badge-short { background: #7c2d12; color: #fed7aa; }
        .section { background: #334155; border: 1px solid #475569; border-radius: 8px; padding: 16px; margin-bottom: 24px; }
        .section-title { font-size: 18px; font-weight: 600; margin-bottom: 16px; }
        .chart-container { position: relative; height: 400px; margin-bottom: 30px; }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="authScreen" class="auth-container">
        <div class="auth-box">
            <h1>L'Art du Trading</h1>
            <p id="authTitle">Connexion</p>
            <input type="text" id="authUsername" placeholder="Identifiant" onkeypress="if(event.key==='Enter') handleAuth()">
            <input type="password" id="authPassword" placeholder="Mot de passe" onkeypress="if(event.key==='Enter') handleAuth()">
            <button onclick="handleAuth()">Valider</button>
            <div class="auth-toggle">
                <span id="toggleText">Pas de compte ? <a onclick="toggleAuthMode()">S'inscrire</a></span>
            </div>
        </div>
    </div>

    <!-- App Screen -->
    <div id="appScreen" class="container hidden">
        <div class="header">
            <div>
                <h1>L'Art du Trading</h1>
                <p class="subtitle">Delinvest - Track Record</p>
            </div>
            <div style="display: flex; gap: 12px;">
                <button class="btn-purple" onclick="toggleAccountManager()">‚ûï Compte</button>
                <button class="btn-red" onclick="logout()">D√©connexion</button>
            </div>
        </div>

        <div id="accountManager" class="section hidden">
            <div class="section-title">Cr√©er un compte</div>
            <input type="text" id="newAccountName" placeholder="Nom du compte" class="form-input">
            <input type="number" id="newAccountCapital" placeholder="Capital initial" class="form-input" value="10000">
            <button class="btn-green" onclick="createAccount()">Cr√©er</button>
        </div>

        <div class="account-selector">
            <span style="color: #94a3b8;">Compte:</span>
            <div id="accountButtons"></div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab(0)">üìä Dashboard</button>
            <button class="tab" onclick="switchTab(1)">üìù Journal</button>
            <button class="tab" onclick="switchTab(2)">üìä Stats</button>
        </div>

        <!-- Dashboard -->
        <div class="content active">
            <div class="kpi-grid">
                <div class="kpi-card"><div class="kpi-label">Performance</div><div class="kpi-value green" id="perf">0%</div></div>
                <div class="kpi-card"><div class="kpi-label">Capital</div><div class="kpi-value blue" id="capital">$0</div></div>
                <div class="kpi-card"><div class="kpi-label">Winrate</div><div class="kpi-value cyan" id="winrate">0%</div></div>
                <div class="kpi-card"><div class="kpi-label">Trades</div><div class="kpi-value" style="color: #a78bfa;" id="totalTrades">0</div></div>
            </div>
        </div>

        <!-- Journal -->
        <div class="content">
            <button class="btn-green" style="margin-bottom: 16px;" onclick="toggleForm()">+ Ajouter Trade</button>
            <div id="form" class="section hidden">
                <h3 style="margin-bottom: 16px;">Nouveau Trade</h3>
                <input type="date" id="date" class="form-input">
                <select id="asset" class="form-input"><option>NAS100</option><option>DAX40</option><option>GOLD</option></select>
                <select id="direction" class="form-input"><option>Long</option><option>Short</option></select>
                <input type="number" id="entry" placeholder="Entr√©e" class="form-input" step="0.01">
                <input type="number" id="sl" placeholder="SL" class="form-input" step="0.01">
                <input type="number" id="tp" placeholder="TP" class="form-input" step="0.01">
                <input type="number" id="result" placeholder="R√©sultat $" class="form-input" step="0.01">
                <textarea id="comment" placeholder="Commentaire..." class="form-input" style="height: 60px;"></textarea>
                <button class="btn-green" onclick="addTrade()" style="margin-right: 8px;">Ajouter</button>
                <button class="btn-blue" onclick="toggleForm()">Annuler</button>
            </div>
            <table><thead><tr><th>Date</th><th>Actif</th><th>Dir</th><th>Entr√©e</th><th>R√©sultat</th><th>Action</th></tr></thead><tbody id="tradesBody"></tbody></table>
        </div>

        <!-- Stats -->
        <div class="content">
            <div class="section">
                <div class="section-title">Equity Curve</div>
                <div class="chart-container"><canvas id="equityChart"></canvas></div>
            </div>
        </div>
    </div>

    <script>
        const API = '/api';
        let authMode = 'login';
        let userId = null;
        let currentAccount = null;
        let accounts = [];
        let trades = [];
        let equityChart = null;

        function toggleAuthMode() {
            authMode = authMode === 'login' ? 'register' : 'login';
            document.getElementById('authTitle').textContent = authMode === 'login' ? 'Connexion' : 'Inscription';
            document.getElementById('toggleText').innerHTML = authMode === 'login' 
                ? 'Pas de compte ? <a onclick="toggleAuthMode()">S\'inscrire</a>'
                : 'D√©j√† inscrit ? <a onclick="toggleAuthMode()">Se connecter</a>';
        }

        async function handleAuth() {
            const username = document.getElementById('authUsername').value;
            const password = document.getElementById('authPassword').value;
            if (!username || !password) return alert('Remplissez les champs');

            try {
                const endpoint = authMode === 'register' ? '/api/register' : '/api/login';
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                if (!res.ok) return alert(data.error);
                
                if (authMode === 'register') {
                    alert('Compte cr√©√© ! Connectez-vous');
                    toggleAuthMode();
                } else {
                    userId = data.user_id;
                    localStorage.setItem('userId', userId);
                    showApp();
                    loadAccounts();
                }
            } catch (e) {
                alert('Erreur: ' + e.message);
            }
        }

        async function loadAccounts() {
            try {
                const res = await fetch(`${API}/accounts/${userId}`);
                accounts = await res.json();
                updateAccountButtons();
                if (accounts.length > 0) switchAccount(accounts[0].id);
                else createDefaultAccount();
            } catch (e) {
                console.error(e);
            }
        }

        async function createDefaultAccount() {
            try {
                const res = await fetch(`${API}/accounts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, name: 'Principal', capital: 10000 })
                });
                const acc = await res.json();
                accounts.push(acc);
                updateAccountButtons();
                switchAccount(acc.id);
            } catch (e) {
                console.error(e);
            }
        }

        async function createAccount() {
            const name = document.getElementById('newAccountName').value;
            const capital = parseFloat(document.getElementById('newAccountCapital').value);
            if (!name || !capital) return alert('Remplissez les champs');

            try {
                const res = await fetch(`${API}/accounts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, name, capital })
                });
                const acc = await res.json();
                accounts.push(acc);
                document.getElementById('newAccountName').value = '';
                document.getElementById('newAccountCapital').value = '10000';
                updateAccountButtons();
                switchAccount(acc.id);
                toggleAccountManager();
            } catch (e) {
                alert('Erreur: ' + e.message);
            }
        }

        function updateAccountButtons() {
            const container = document.getElementById('accountButtons');
            container.innerHTML = '';
            accounts.forEach(acc => {
                const btn = document.createElement('button');
                btn.className = 'account-button' + (acc.id === currentAccount ? ' active' : '');
                btn.textContent = acc.name + ' ($' + acc.capital + ')';
                btn.onclick = () => switchAccount(acc.id);
                container.appendChild(btn);
            });
        }

        async function switchAccount(id) {
            currentAccount = id;
            updateAccountButtons();
            await loadTrades();
            updateUI();
        }

        async function loadTrades() {
            try {
                const res = await fetch(`${API}/trades/${currentAccount}`);
                trades = await res.json();
            } catch (e) {
                console.error(e);
            }
        }

        async function addTrade() {
            const entry = parseFloat(document.getElementById('entry').value);
            const sl = parseFloat(document.getElementById('sl').value);
            const tp = parseFloat(document.getElementById('tp').value);
            const result = parseFloat(document.getElementById('result').value);
            if (!entry || !sl || !tp || result === '' || result === null) return alert('Remplissez tous les champs');

            try {
                await fetch(`${API}/trades`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        account_id: currentAccount,
                        date: document.getElementById('date').value,
                        asset: document.getElementById('asset').value,
                        direction: document.getElementById('direction').value,
                        entry: entry.toFixed(2),
                        sl: sl.toFixed(2),
                        tp: tp.toFixed(2),
                        resultUSD: result.toFixed(2),
                        comment: document.getElementById('comment').value
                    })
                });
                document.getElementById('entry').value = '';
                document.getElementById('sl').value = '';
                document.getElementById('tp').value = '';
                document.getElementById('result').value = '';
                document.getElementById('comment').value = '';
                toggleForm();
                await loadTrades();
                updateUI();
            } catch (e) {
                alert('Erreur: ' + e.message);
            }
        }

        async function deleteTrade(id) {
            if (!confirm('Supprimer ?')) return;
            try {
                await fetch(`${API}/trades/${id}`, { method: 'DELETE' });
                await loadTrades();
                updateUI();
            } catch (e) {
                alert('Erreur: ' + e.message);
            }
        }

        function updateUI() {
            const account = accounts.find(a => a.id === currentAccount);
            const totalPnL = trades.reduce((sum, t) => sum + parseFloat(t.resultUSD || 0), 0);
            const wins = trades.filter(t => parseFloat(t.resultUSD) > 0).length;
            const perf = account ? ((totalPnL / account.capital) * 100).toFixed(2) : 0;
            const winrate = trades.length > 0 ? ((wins / trades.length) * 100).toFixed(0) : 0;

            document.getElementById('perf').textContent = perf + '%';
            document.getElementById('capital').textContent = '$' + (account ? (account.capital + totalPnL).toFixed(0) : 0);
            document.getElementById('winrate').textContent = winrate + '%';
            document.getElementById('totalTrades').textContent = trades.length;

            updateTradesTable();
            updateChart();
        }

        function updateTradesTable() {
            const tbody = document.getElementById('tradesBody');
            tbody.innerHTML = '';
            if (trades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #94a3b8;">Aucun trade</td></tr>';
                return;
            }
            trades.slice().reverse().forEach(t => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${t.date}</td><td>${t.asset}</td><td><span class="badge ${t.direction === 'Long' ? 'badge-long' : 'badge-short'}">${t.direction[0]}</span></td><td>${t.entry}</td><td style="color: ${parseFloat(t.resultUSD) > 0 ? '#4ade80' : '#f87171'}">$${t.resultUSD}</td><td><button onclick="deleteTrade(${t.id})" class="btn-red">√ó</button></td>`;
                tbody.appendChild(row);
            });
        }

        function updateChart() {
            const account = accounts.find(a => a.id === currentAccount);
            if (!account) return;

            const labels = [];
            const equityData = [];
            let running = account.capital;
            trades.slice().sort((a, b) => new Date(a.date) - new Date(b.date)).forEach(t => {
                running += parseFloat(t.resultUSD || 0);
                labels.push(t.date);
                equityData.push(running);
            });

            if (labels.length === 0) {
                labels.push('Pas de donn√©es');
                equityData.push(account.capital);
            }

            const ctx = document.getElementById('equityChart');
            if (ctx) {
                if (equityChart) equityChart.destroy();
                equityChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Capital',
                            data: equityData,
                            borderColor: '#06b6d4',
                            backgroundColor: 'rgba(6, 182, 212, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { labels: { color: '#cbd5e1' } } },
                        scales: {
                            y: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' } },
                            x: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' } }
                        }
                    }
                });
            }
        }

        function toggleForm() {
            document.getElementById('form').classList.toggle('hidden');
            if (!document.getElementById('form').classList.contains('hidden')) {
                document.getElementById('date').valueAsDate = new Date();
            }
        }

        function toggleAccountManager() {
            document.getElementById('accountManager').classList.toggle('hidden');
        }

        function switchTab(idx) {
            document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.content')[idx].classList.add('active');
            document.querySelectorAll('.tab')[idx].classList.add('active');
        }

        function showApp() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('hidden');
        }

        function logout() {
            if (confirm('D√©connexion ?')) {
                userId = null;
                currentAccount = null;
                localStorage.removeItem('userId');
                document.getElementById('authScreen').classList.remove('hidden');
                document.getElementById('appScreen').classList.add('hidden');
                document.getElementById('authUsername').value = '';
                document.getElementById('authPassword').value = '';
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem('userId');
            if (saved) {
                userId = saved;
                showApp();
                loadAccounts();
            }
        });
    </script>
</body>
</html>


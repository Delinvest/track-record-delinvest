
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L'Art du Trading</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%); color: #fff; min-height: 100vh; padding: 24px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .auth-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .auth-box { background: #334155; border: 1px solid #475569; border-radius: 8px; padding: 40px; text-align: center; max-width: 400px; }
        .auth-box h1 { font-size: 28px; margin-bottom: 8px; background: linear-gradient(90deg, #60a5fa, #22d3ee); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .auth-box p { color: #94a3b8; margin-bottom: 24px; }
        .auth-box input { width: 100%; padding: 12px; margin-bottom: 16px; background: #475569; border: 1px solid #334155; color: white; border-radius: 6px; font-size: 14px; }
        .auth-box button { width: 100%; padding: 12px; background: #16a34a; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-bottom: 12px; }
        .auth-box button:hover { background: #15803d; }
        .auth-toggle { color: #94a3b8; font-size: 14px; cursor: pointer; }
        .auth-toggle a { color: #60a5fa; }
        h1 { font-size: 36px; font-weight: bold; margin-bottom: 4px; background: linear-gradient(90deg, #60a5fa, #22d3ee); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .subtitle { color: #94a3b8; margin-bottom: 24px; font-size: 14px; }
        .header { border-bottom: 1px solid #334155; padding-bottom: 24px; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; }
        button { padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s; font-size: 14px; }
        .btn-blue { background: #2563eb; color: white; }
        .btn-blue:hover { background: #1d4ed8; }
        .btn-green { background: #16a34a; color: white; }
        .btn-green:hover { background: #15803d; }
        .btn-purple { background: #9333ea; color: white; }
        .btn-purple:hover { background: #7e22ce; }
        .btn-red { background: #dc2626; color: white; }
        .btn-red:hover { background: #b91c1c; }
        .account-selector { display: flex; gap: 8px; align-items: center; margin-bottom: 16px; flex-wrap: wrap; }
        .account-button { padding: 8px 12px; border: 2px solid #475569; border-radius: 6px; background: transparent; color: #cbd5e1; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .account-button.active { border-color: #06b6d4; background: rgba(6, 182, 212, 0.2); color: #06b6d4; }
        .tabs { display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; }
        .tab { padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; background: #475569; color: #cbd5e1; transition: all 0.3s; border: none; font-size: 14px; }
        .tab.active { background: linear-gradient(90deg, #3b82f6, #06b6d4); color: #0f172a; }
        .content { display: none; }
        .content.active { display: block; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .kpi-card { background: #334155; border: 1px solid #475569; border-radius: 8px; padding: 20px; }
        .kpi-label { color: #94a3b8; font-size: 12px; margin-bottom: 8px; text-transform: uppercase; }
        .kpi-value { font-size: 28px; font-weight: bold; margin-bottom: 4px; }
        .green { color: #4ade80; }
        .blue { color: #60a5fa; }
        .cyan { color: #06b6d4; }
        .red { color: #f87171; }
        .purple { color: #a78bfa; }
        .form-group { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px; }
        .form-input { background: #475569; border: 1px solid #334155; color: white; padding: 8px 12px; border-radius: 6px; font-size: 14px; }
        .form-input:focus { outline: none; border-color: #3b82f6; }
        .hidden { display: none !important; }
        table { width: 100%; border-collapse: collapse; background: #334155; border-radius: 8px; overflow: hidden; margin-bottom: 24px; }
        thead { background: #1e293b; }
        th, td { padding: 12px 16px; text-align: left; font-size: 13px; }
        td { border-bottom: 1px solid #475569; }
        tbody tr:hover { background: #3f4654; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .badge-long { background: #166534; color: #86efac; }
        .badge-short { background: #7c2d12; color: #fed7aa; }
        .section { background: #334155; border: 1px solid #475569; border-radius: 8px; padding: 16px; margin-bottom: 24px; }
        .section-title { font-size: 18px; font-weight: 600; margin-bottom: 16px; }
        .chart-container { position: relative; height: 400px; margin-bottom: 30px; }
        .account-form { display: grid; grid-template-columns: 1fr 1fr auto; gap: 12px; margin-bottom: 16px; }
        .trade-card { background: #334155; border: 1px solid #475569; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
        .trade-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .trade-meta { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 12px; font-size: 13px; }
        .trade-comment { background: #475569; padding: 12px; border-radius: 6px; margin-top: 12px; font-size: 13px; }
        .trade-result { padding: 8px 12px; border-radius: 6px; font-size: 14px; font-weight: bold; margin-top: 8px; }
        .trade-result.win { background: #166534; color: #86efac; }
        .trade-result.loss { background: #7c2d12; color: #fed7aa; }
        .trade-image { max-width: 100%; max-height: 300px; border-radius: 6px; margin-top: 12px; cursor: pointer; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { position: relative; max-width: 90%; max-height: 90%; }
        .modal-content img { max-width: 100%; max-height: 90vh; }
        .close-modal { position: absolute; top: 20px; right: 30px; color: white; font-size: 40px; cursor: pointer; }
        .image-preview { max-width: 200px; max-height: 150px; margin-top: 8px; border-radius: 6px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; }
        .stat-box { background: #475569; padding: 12px; border-radius: 6px; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; }
        .stat-label { color: #94a3b8; }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="authScreen" class="auth-container">
        <div class="auth-box">
            <h1>L'Art du Trading</h1>
            <p id="authTitle">Connexion</p>
            <input type="text" id="authUsername" placeholder="Identifiant" onkeypress="if(event.key==='Enter') handleAuth()">
            <input type="password" id="authPassword" placeholder="Mot de passe" onkeypress="if(event.key==='Enter') handleAuth()">
            <button onclick="handleAuth()">Valider</button>
            <div class="auth-toggle">
                <span id="toggleText">Pas de compte ? <a onclick="toggleAuthMode()">S'inscrire</a></span>
            </div>
        </div>
    </div>

    <!-- App Screen -->
    <div id="appScreen" class="container hidden">
        <div class="header">
            <div>
                <h1>L'Art du Trading</h1>
                <p class="subtitle">Delinvest - Track Record</p>
            </div>
            <div style="display: flex; gap: 12px;">
                <button class="btn-purple" onclick="toggleAccountManager()">‚ûï Compte</button>
                <button class="btn-red" onclick="logout()">D√©connexion</button>
            </div>
        </div>

        <div id="accountManager" class="section hidden">
            <div class="section-title">Cr√©er un compte</div>
            <div class="account-form">
                <input type="text" id="newAccountName" placeholder="Nom du compte" class="form-input">
                <input type="number" id="newAccountCapital" placeholder="Capital initial" class="form-input" value="10000">
                <button class="btn-green" onclick="createAccount()">Cr√©er</button>
            </div>
        </div>

        <div class="account-selector">
            <span style="color: #94a3b8;">Compte:</span>
            <div id="accountButtons"></div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab(0)">üìä Dashboard</button>
            <button class="tab" onclick="switchTab(1)">üìù Journal</button>
            <button class="tab" onclick="switchTab(2)">üìä Stats</button>
            <button class="tab" onclick="switchTab(3)">üí¨ Trades</button>
        </div>

        <!-- Dashboard -->
        <div class="content active">
            <div class="kpi-grid">
                <div class="kpi-card"><div class="kpi-label">Performance</div><div class="kpi-value green" id="perf">0%</div></div>
                <div class="kpi-card"><div class="kpi-label">Capital</div><div class="kpi-value blue" id="capital">$0</div></div>
                <div class="kpi-card"><div class="kpi-label">Winrate</div><div class="kpi-value cyan" id="winrate">0%</div></div>
                <div class="kpi-card"><div class="kpi-label">Profit Factor</div><div class="kpi-value purple" id="pf">0</div></div>
                <div class="kpi-card"><div class="kpi-label">Max DD</div><div class="kpi-value red" id="maxdd">0%</div></div>
                <div class="kpi-card"><div class="kpi-label">Avg Gain</div><div class="kpi-value green" id="avggain">$0</div></div>
            </div>
        </div>

        <!-- Journal -->
        <div class="content">
            <button class="btn-green" style="margin-bottom: 16px;" onclick="toggleForm()">+ Ajouter Trade</button>
            <div id="form" class="section hidden">
                <h3 style="margin-bottom: 16px;">Nouveau Trade</h3>
                <div class="form-group">
                    <input type="date" id="date" class="form-input">
                    <select id="asset" class="form-input"><option>NAS100</option><option>DAX40</option><option>GOLD</option><option>SPX500</option><option>EUR/USD</option><option>DJ30</option></select>
                    <select id="setup" class="form-input"><option>Delinvest Prime</option><option>Delinvest Zone</option></select>
                    <select id="direction" class="form-input"><option>Long</option><option>Short</option></select>
                    <input type="number" id="entry" placeholder="Entr√©e" class="form-input" step="0.01">
                    <input type="number" id="sl" placeholder="SL" class="form-input" step="0.01">
                    <input type="number" id="tp" placeholder="TP" class="form-input" step="0.01">
                    <input type="number" id="result" placeholder="R√©sultat $" class="form-input" step="0.01">
                    <input type="number" id="leverage" placeholder="Levier" class="form-input" value="1" step="0.1">
                    <textarea id="comment" placeholder="Commentaire..." class="form-input" style="grid-column: 1 / -1; height: 60px;"></textarea>
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; color: #94a3b8; font-size: 12px; margin-bottom: 8px;">Screenshot (optionnel)</label>
                    <input type="file" id="screenshot" accept="image/*" class="form-input" onchange="previewScreenshot()">
                    <img id="screenshotPreview" class="image-preview" style="display:none;">
                </div>
                <button class="btn-green" onclick="addTrade()" style="margin-right: 8px;">Ajouter</button>
                <button class="btn-blue" onclick="toggleForm()">Annuler</button>
            </div>
            <table><thead><tr><th>Date</th><th>Actif</th><th>Setup</th><th>Dir</th><th>Entr√©e</th><th>R:R</th><th>R√©sultat</th><th>Action</th></tr></thead><tbody id="tradesBody"></tbody></table>
        </div>

        <!-- Stats -->
        <div class="content">
            <div class="section">
                <div class="section-title">Equity Curve</div>
                <div class="chart-container"><canvas id="equityChart"></canvas></div>
            </div>
            <div class="section">
                <div class="section-title">P&L par Trade</div>
                <div class="chart-container"><canvas id="balanceChart"></canvas></div>
            </div>
        </div>

        <!-- Trades D√©taill√©s -->
        <div class="content" id="tradesDetails"></div>
    </div>

    <div id="imageModal" class="modal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <img id="modalImage" src="">
        </div>
    </div>

    <script>
        const API = '/api';
        let authMode = 'login';
        let userId = null;
        let currentAccount = null;
        let accounts = [];
        let trades = [];
        let currentScreenshot = null;
        let equityChart = null;
        let balanceChart = null;

        function toggleAuthMode() {
            authMode = authMode === 'login' ? 'register' : 'login';
            document.getElementById('authTitle').textContent = authMode === 'login' ? 'Connexion' : 'Inscription';
            document.getElementById('toggleText').innerHTML = authMode === 'login' 
                ? 'Pas de compte ? <a onclick="toggleAuthMode()">S\'inscrire</a>'
                : 'D√©j√† inscrit ? <a onclick="toggleAuthMode()">Se connecter</a>';
        }

        async function handleAuth() {
            const username = document.getElementById('authUsername').value;
            const password = document.getElementById('authPassword').value;
            if (!username || !password) return alert('Remplissez les champs');

            try {
                const endpoint = authMode === 'register' ? '/api/register' : '/api/login';
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                if (!res.ok) return alert(data.error);
                
                if (authMode === 'register') {
                    alert('Compte cr√©√© ! Connectez-vous');
                    toggleAuthMode();
                } else {
                    userId = data.user_id;
                    localStorage.setItem('userId', userId);
                    showApp();
                    loadAccounts();
                }
            } catch (e) {
                alert('Erreur: ' + e.message);
            }
        }

        async function loadAccounts() {
            try {
                const res = await fetch(`${API}/accounts/${userId}`);
                accounts = await res.json();
                updateAccountButtons();
                if (accounts.length > 0) switchAccount(accounts[0].id);
                else createDefaultAccount();
            } catch (e) {
                alert('Erreur: ' + e.message);
            }
        }

        async function createDefaultAccount() {
            try {
                const res = await fetch(`${API}/accounts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, name: 'Principal', capital: 10000 })
                });
                const acc = await res.json();
                accounts.push(acc);
                updateAccountButtons();
                switchAccount(acc.id);
            } catch (e) {
                alert('Erreur: ' + e.message);
            }
        }

        async function createAccount() {
            const name = document.getElementById('newAccountName').value;
            const capital = parseFloat(document.getElementById('newAccountCapital').value);
            if (!name || !capital) return alert('Remplissez les champs');

            try {
                const res = await fetch(`${API}/accounts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, name, capital })
                });
                const acc = await res.json();
                accounts.push(acc);
                document.getElementById('newAccountName').value = '';
                document.getElementById('newAccountCapital').value = '10000';
                updateAccountButtons();
                switchAccount(acc.id);
                toggleAccountManager();
            } catch (e) {
                alert('Erreur: ' + e.message);
            }
        }

        function updateAccountButtons() {
            const container = document.getElementById('accountButtons');
            container.innerHTML = '';
            accounts.forEach(acc => {
                const btn = document.createElement('button');
                btn.className = 'account-button' + (acc.id === currentAccount ? ' active' : '');
                btn.textContent = acc.name + ' ($' + acc.capital + ')';
                btn.onclick = () => switchAccount(acc.id);
                container.appendChild(btn);
            });
        }

        async function switchAccount(id) {
            currentAccount = id;
            updateAccountButtons();
            await loadTrades();
            updateUI();
        }

        async function loadTrades() {
            try {
                const res = await fetch(`${API}/trades/${currentAccount}`);
                trades = await res.json();
            } catch (e) {
                alert('Erreur: ' + e.message);
            }
        }

        function previewScreenshot() {
            const file = document.getElementById('screenshot').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentScreenshot = e.target.result;
                    document.getElementById('screenshotPreview').src = currentScreenshot;
                    document.getElementById('screenshotPreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function calculateRR(entry, sl, tp, dir) {
            if (!entry || !sl || !tp) return 0;
            const e = parseFloat(entry), s = parseFloat(sl), t = parseFloat(tp);
            if (dir === 'Long') {
                const risk = e - s, reward = t - e;
                return risk > 0 ? (reward / risk).toFixed(2) : 0;
            } else {
                const risk = s - e, reward = e - t;
                return risk > 0 ? (reward / risk).toFixed(2) : 0;
            }
        }

        async function addTrade() {
            const entry = parseFloat(document.getElementById('entry').value);
            const sl = parseFloat(document.getElementById('sl').value);
            const tp = parseFloat(document.getElementById('tp').value);
            const result = parseFloat(document.getElementById('result').value);
            if (!entry || !sl || !tp || result === '' || result === null) return alert('Remplissez tous les champs');

            try {
                await fetch(`${API}/trades`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        account_id: currentAccount,
                        date: document.getElementById('date').value,
                        asset: document.getElementById('asset').value,
                        setup: document.getElementById('setup').value,
                        direction: document.getElementById('direction').value,
                        entry: entry.toFixed(2),
                        sl: sl.toFixed(2),
                        tp: tp.toFixed(2),
                        rr: calculateRR(entry, sl, tp, document.getElementById('direction').value),
                        resultUSD: result.toFixed(2),
                        leverage: parseFloat(document.getElementById('leverage').value),
                        comment: document.getElementById('comment').value,
                        screenshot: currentScreenshot
                    })
                });
                document.getElementById('entry').value = '';
                document.getElementById('sl').value = '';
                document.getElementById('tp').value = '';
                document.getElementById('result').value = '';
                document.getElementById('comment').value = '';
                document.getElementById('screenshot').value = '';
                document.getElementById('screenshotPreview').style.display = 'none';
                currentScreenshot = null;
                toggleForm();
                await loadTrades();
                updateUI();
            } catch (e) {
                alert('Erreur: ' + e.message);
            }
        }

        async function deleteTrade(id) {
            if (!confirm('Supprimer ce trade ?')) return;
            try {
                await fetch(`${API}/trades/${id}`, { method: 'DELETE' });
                await loadTrades();
                updateUI();
            } catch (e) {
                alert('Erreur: ' + e.message);
            }
        }

        function updateUI() {
            updateStats();
            updateTradesTable();
            updateTradesCards();
            updateCharts();
        }

        function updateStats() {
            const account = accounts.find(a => a.id === currentAccount);
            const totalPnL = trades.reduce((sum, t) => sum + parseFloat(t.resultUSD || 0), 0);
            const wins = trades.filter(t => parseFloat(t.resultUSD) > 0).length;
            const losses = trades.length - wins;
            const perf = account ? ((totalPnL / account.capital) * 100).toFixed(2) : 0;
            const winrate = trades.length > 0 ? ((wins / trades.length) * 100).toFixed(0) : 0;
            const avgGain = wins > 0 ? (trades.filter(t => parseFloat(t.resultUSD) > 0).reduce((sum, t) => sum + parseFloat(t.resultUSD), 0) / wins).toFixed(2) : 0;
            const avgLoss = losses > 0 ? (Math.abs(trades.filter(t => parseFloat(t.resultUSD) < 0).reduce((sum, t) => sum + parseFloat(t.resultUSD), 0)) / losses).toFixed(2) : 0;
            const pf = avgLoss > 0 ? (avgGain / avgLoss).toFixed(2) : 0;

            let runCap = account.capital, maxCap = account.capital, maxDD = 0;
            trades.forEach(t => {
                runCap += parseFloat(t.resultUSD || 0);
                maxCap = Math.max(maxCap, runCap);
                const dd = ((maxCap - runCap) / maxCap) * 100;
                maxDD = Math.max(maxDD, dd);
            });

            document.getElementById('perf').textContent = perf + '%';
            document.getElementById('capital').textContent = '$' + (account.capital + totalPnL).toFixed(0);
            document.getElementById('winrate').textContent = winrate + '%';
            document.getElementById('pf').textContent = pf;
            document.getElementById('maxdd').textContent = maxDD.toFixed(2) + '%';
            document.getElementById('avggain').textContent = '$' + avgGain;
        }

        function updateTradesTable() {
            const tbody = document.getElementById('tradesBody');
            tbody.innerHTML = '';
            if (trades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #94a3b8;">Aucun trade</td></tr>';
                return;
            }
            trades.slice().reverse().forEach(t => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${t.date}</td><td>${t.asset}</td><td>${t.setup}</td><td><span class="badge ${t.direction === 'Long' ? 'badge-long' : 'badge-short'}">${t.direction[0]}</span></td><td>${t.entry}</td><td style="color: #60a5fa;">${t.rr}</td><td style="color: ${parseFloat(t.resultUSD) > 0 ? '#4ade80' : '#f87171'}">$${t.resultUSD}</td><td><button onclick="deleteTrade(${t.id})" class="btn-red">√ó</button></td>`;
                tbody.appendChild(row);
            });
        }

        function updateTradesCards() {
            const container = document.getElementById('tradesDetails');
            if (trades.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 40px;">Aucun trade</div>';
                return;
            }
            let html = '';
            trades.slice().reverse().forEach(t => {
                const isWin = parseFloat(t.resultUSD) > 0;
                let img = '';
                if (t.screenshot) img = `<img class="trade-image" src="${t.screenshot}" onclick="openModal('${t.screenshot}')">`;
                html += `<div class="trade-card"><div class="trade-header"><div><strong>${t.asset}</strong> ‚Ä¢ ${t.setup}</div><span class="badge ${t.direction === 'Long' ? 'badge-long' : 'badge-short'}">${t.direction}</span></div><div class="trade-meta"><div><span style="color: #94a3b8;">Entr√©e:</span> ${t.entry}</div><div><span style="color: #94a3b8;">SL:</span> ${t.sl}</div><div><span style="color: #94a3b8;">TP:</span> ${t.tp}</div><div><span style="color: #94a3b8;">R:R:</span> <span style="color: #60a5fa;">${t.rr}</span></div></div><div class="trade-result ${isWin ? 'win' : 'loss'}">${isWin ? '‚úì +' : '‚úó '}$${t.resultUSD}</div><div class="trade-comment">üí¨ ${t.comment || '-'}</div>${img}</div>`;
            });
            container.innerHTML = html;
        }

        function updateCharts() {
            const account = accounts.find(a => a.id === currentAccount);
            if (!account) return;

            const labels = [];
            const equityData = [];
            const balanceData = [];
            let running = account.capital;
